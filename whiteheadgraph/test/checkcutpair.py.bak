import whiteheadgraph.build.wgraph as wg
import copy
import word
import whiteheadgraph.build.orderedmultigraph as omg
import whiteheadgraph.split.split as split
import AutF as aut
import whiteheadgraph.build.whiteheadreduce as wreduce
from whiteheadgraph.test.knownexamples import *






def cutpairtest(maxlength,verbose,randomautomorphismlength,examplename,whiteheadgraph,wordlist,splitsfreely,iscircle,isrigid,cutpoints,uncrossed):
    nonefailed=True
    # take a known example and mix it up with an automorphism alpha
    rank=whiteheadgraph.rank
    alpha,alphainv=aut.randomAutomorphismPair(rank,randomautomorphismlength)

    if verbose:
        print "Trying example ", examplename, " changed by automorphism:\n", alpha
    
    minimization=wreduce.WhiteheadMinimize([alpha(w) for w in wordlist])
    newwordlist=minimization['wordlist']
    wseq=minimization['whiteheadsequence']
    # wordlist=product(wseq)*alpha(oldwordlist)
    W=wg.WGraph(newwordlist)
    wholeautomorphism=aut.product(*wseq)*alpha
    newcutpoints=[wholeautomorphism(cutpoint) for cutpoint in cutpoints] 
    newuncrossed=[wholeautomorphism(uncross) for uncross in uncrossed]
    
    if not wg.areEquivalentWordlists(W.getWordlist(),newwordlist):
        if verbose:
            print "Error in getWordlist for ", examplename
        nonefailed=False
    if  splitsfreely!=split.splitsFreely(W):
        if verbose:
            print "Error in splitsFreely for ", examplename
        nonefailed=False
    if  iscircle!=W.isCircle():
        if verbose:
            print "Error in isCircle for ", examplename
        nonefailed=False
    if isrigid!=split.isRigid(W,maxlength):
        if verbose:
            print "Error in isRigid for ", examplename
        nonefailed=False
    if not wg.areEquivalentWordlists(newcutpoints,split.findCutPoints(W)):
        if verbose:
            print "Error in split.findCutPoints for ", examplename
        nonefailed=False
    cuts=split.findCutPairs(W,maxlength)[0]
    if not wg.areEquivalentWordlists(cuts['cutpoints'],newcutpoints):
        if verbose:
            print "Error finding cut points in split.findCutPairs for ", examplename
        nonefailed=False
    if not wg.simplifyWordlist(cuts['uncrossed'],newuncrossed)==[]:
        if verbose:
            print "Error too many uncrossed cut pairs in split.findCutPairs for ", examplename
        nonefailed=False
    if not wg.simplifyWordlist(newuncrossed,set.union(set(cuts['uncrossed']),set(cuts['othercuts'])))==[]:
        if verbose:
            print "Error didn't find all uncrossed cut pairs in split.findCutPairs for ", examplename
        nonefailed=False        

    # test some random words to see if splitting info is correct
    for i in range(1,maxlength):
        w=word.randomword(2,i)
        w=word.cyclicReduce(w)
        if len(w)>0:
            if iscircle:
                if not split.givesCut(W,w)!=word.isConjugateInto(w,*newwordlist):
                    if verbose:
                        print "Error: W is a circle, so ",w," should be a cut pair in ", examplename
                    nonefailed=False
                    break
            else:
                if not split.givesCut(W,w)==word.isConjugateInto(w,*set.union(set(newuncrossed),set(newcutpoints))):
                    if verbose:
                        print "Warning",w," gives a cut but wasn't found in ", examplename
                        print "It may be that ",w," is a crossed cut pair and everything is ok."
                    #nonefailed=False
                    break
    if verbose and nonefailed:
        print "All tests passed for ",examplename,"."
    return nonefailed
        
def testall(maxlength=30, randomautomorphismlength=0,verbose=False):
    
    if all([cutpairtest(maxlength,verbose,randomautomorphismlength,k,**knownexamples[k]) for k in knownexamples]):
        print "All passed"
    else:
        print "Some tests failed"
    


